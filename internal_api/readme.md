# Internal API

This exploit uses the internal Eduka api which can be found at [this](https://klase.eduka.lt/api/) (`https://klase.eduka.lt/api/`) endpoint. The internal api exposes a lot of information. This vulnerability can be taken advantage of from any code or app that can send basic http requests.

---

## About

It seems that the Eduka platform internal api that handles quiz answers, students answered questions, scoring and other internal functions is public and easily accessible. In fact the only requirements for accessing this api are:

- Correct api endpoint
- Eduka platform authentication

## Requirements

The following section defines all of the requirements above, describes them and gives example ways to fulfill them.

### API endpoints

The internal Eduka api has a lot of different endpoints. All of them append to the main api endpoint `https://klase.eduka.lt/`, but some of them might require additional data to be passed to the request, while others might need specific account authentication (meaning that they can't possibly be called with a students account). Luckily all of this info about api endpoints and their requirements is stored in a file available on eduka [host](https://klase.eduka.lt/js/routing?callback=fos.Router.setData) or in [this repo](routing.js). This file contains a JS object with `routes` property in which each individual api endpoint has it's own property.
Take the following property as an example:

```JavaScript
"app_api_student_quiztemplates_resultxml": {
    "tokens": [
        ["variable", "\/", "perziura|priskyrimas-uzrakinta|sprendimas|demonstracija", "mode"],
        ["variable", "\/", "\\d{1,9}", "id"],
        ["text", "\/api\/student\/quiz-templates\/result-xml"]
    ],
    "defaults": [],
    "requirements": {
        "id": "\\d{1,9}",
        "mode": "perziura|priskyrimas-uzrakinta|sprendimas|demonstracija"
    },
    "hosttokens": [],
    "methods": ["GET"],
    "schemes": []
}
```

From the name `app_api_student_quiztemplates_resultxml` we can see that the endpoint will require student account authentication.

Notice, that the most important stuff is stored in the `tokens` property, from it we can find out that the api endpoint will be:

```text
https://klase.eduka.lt/ + /api/student/quiz-templates/result-xml = https://klase.eduka.lt/api/student/quiz-templates/result-xml
```

And that his endpoint will have two possible variables which are called `id` and `mode`. These variables also include regex conditions that have to be satisfied, so our **id** (regex: `\d{1,9}`) has to be a digit between 1 and 9 long, while our **mode** has to be a one of the following strings:

`perziura|priskyrimas-uzrakinta|sprendimas|demonstracija`

Also in the `requirements` property we can see that both the **id** and **mode** variables are required, meaning that without them our request to the constructed endpoint would fail.
Considering all of these requirements the final api endpoint might look like this:

```text
https://klase.eduka.lt/api/student/quiz-templates/result-xml/1234567/sprendimas
```

Keep in mind that this is not the only possible endpoint, the **mode** variable could be changed out and the **id** variable could any other digit.

We can call a GET request to this endpoint and hope for the best, but you should
understand that it also might not work - the **id** variable has to be correct and reference something. In this particular situation **id** variable is the quiz id that can be seen in Eduka url while solving a quiz, but for other api endpoints the required data might and will change and you will have to figure out for yourself what data you have to provide.

### Authentication

Any request made to the Eduka api has to be authenticated. Authentication can be achieved in 2 ways:

- **Authentication with normal user credentials (username and password)** - This type of authentication is the most simple, it is done by simply logging in into an Eduka session with valid Eduka account `username` and `password`. This authentication request can be made trough simple http request. **Keep in mind that this type of authentication will log out all other devices that have used the same credentials to log into Eduka.**
- **Authentication using live session id** - This type of authentication involves manually or automatically (check out [browser_cookie3](https://github.com/borisbabic/browser_cookie3) for a possible solution) searching the browsers cookies for `PHPSESSID` cookie, which is created after an authenticated session already exists, retrieving it's value and using it as a cookie in the requests made to the api. While this is harder to do, it has a very nice advantage - **it doesn't log out any other devices or even live sessions in browser from the Eduka platform.**

## Api answers

All of the api answers use some weird obfuscation. I have created a simple python script that can take in an api response string, deobfuscate it and convert it into a python json object:

```python
import json

def parse_response(obscured_string: str):
    """
    Returns `json` object of api response string.
    
    Parses out the response by removing
    backslashes `\`, also removes unnecessary
    quotation marks `"` around `{ }` and `[ ]` tags.
    """
    
    obscured_string = obscured_string.replace("\\", "")
    
    clean_string = ""
    
    for index, char in enumerate(obscured_string):
        if char == "\"":
            if obscured_string[index + 1] in ("{", "["):
                continue
            elif obscured_string[index - 1] in ("}", "]"):
                continue
            else:
                clean_string = clean_string + char
        else:
            clean_string = clean_string + char
    
    return json.loads(clean_string)
```

## Notable endpoints

These are some of the more interesting endpoints that I have found so far, you can check them out, but I urge you to explore the routing.js file for yourself and find what you need there.

### app_api_admin_quiztemplates_data

Provides current points scored for a quiz, can be used to check quiz scores before submitting it.
Doesn't give out answers.

### app_api_student_quiztemplates_taskpackagecontent

Provides all info for a quiz, it's question orders, etc.

### !app_api_student_quiztemplates_resultxml

Contains XML file of quiz with **ANSWERS** included in <![CDATA]> tags. Hard to parse out, but if done it would provide answers for quizzes real time with no need of submitting the quiz.
